# Family Town 개발 가이드라인

## 1. 프로젝트 개요
**대상 플랫폼:** iOS/iPadOS Chrome 브라우저 (PWA 독립 실행)
**핵심 컨셉:** 4인 가족 멀티플레이어 게임 (RPG + 시뮬레이션)
**기술 스택:** 
- **프론트엔드:** PixiJS v7+ (렌더링), Firebase v9 모듈형 (인증/DB)
- **스타일:** 48px 그리드 타일, 골격(Cutout) 애니메이션, 픽셀 아트 (Nearest Scale)

## 2. 기술적 제약 사항 및 iOS 최적화
1.  **렌더링:** `PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST` (필수).
2.  **PWA/터치:** 
    - `overscroll-behavior`, `touch-action: none` 엄격 제어.
    - `user-select: none`으로 텍스트 선택/확대경 방지.
    - `apple-mobile-web-app-capable` 메타 태그.
3.  **오디오:** `AudioContext`는 첫 번째 사용자 상호작용(PIN 키패드 터치)에서 재개되어야 함.
4.  **기기 화면비:** 아이폰/아이패드 세로 비율 고정 (데스크톱에서 시뮬레이션, 모바일에서 아이폰/아이패드의 화면을 가로로 눞혀도 세로모드로만 출력).

## 3. 데이터베이스 스키마 (Firebase Realtime DB)
| 경로 | 구조 및 설명 |
| :--- | :--- |
| `users/{userID}` | `{ pin: "1234", avatar: {...} }` |
| `users/{userID}/characters` | 생성된 캐릭터 목록 (최대 3개). |
| `users/{userID}/currentMap` | 현재 위치 ID (기본값: `"world"`). |
| `players/{userID}` | 임시 게임 상태 (x, y, anim, direction). |
| `players/{userID}/stats` | RPG 스탯: `{ level, xp, hp, max_hp, str... }`. |
| `players/{userID}/inventory` | 개인 아이템. |
| `players/{userID}/wallet` | 화폐: `{ gold: 1000 }`. |
| `world/buildings/{buildID}` | 외부 건물: `{ type, x, y, owner, interiorID }`. |
| `world/drops` | 공유 필드 아이템 (FIFO 픽업). |
| `interiors/{interiorID}/items` | 집 내부 가구 배치. |
| `trades/{sessionID}` | P2P 거래 세션 데이터. |

## 4. 모듈 사양

### A. 인증 시스템 (`src/auth.js`)
- **UI (인트로):** 4개의 분리된 정사각형 입력 박스 (중앙 정렬). 아래: "접속" 버튼 (PIN이 유효할 때만 활성화). 아래: "Auth Key 생성" 텍스트 링크.
- **UI (생성 팝업):** 4개 입력 박스 (새 PIN) + 4개 입력 박스 (PIN 확인). "생성" 버튼은 둘이 일치할 때만 활성화.
- **로직:** DB에 대한 실시간 PIN 검증으로 접속 버튼 활성화. 입력 시 다음 박스로 자동 포커스.
- **트리거:** 첫 상호작용에서 AudioContext 재개.

### B. 로비 및 커스터마이징 (`src/lobby.js`)
- **슬롯:** 3개의 캐릭터 카드.
    - *존재:* 
        - 레이아웃: 50% 왼쪽 (초상화), 50% 오른쪽 (정보 + 버튼).
        - 오른쪽 열: 상단에 이름/정보, 하단에 삭제/접속 버튼.
        - 버튼: 일관된 작은 크기, 오른쪽 하단 정렬.
    - *빈 슬롯:* 검은 실루엣 + [+] 버튼.
- **캐릭터 생성기:** 
    - **파츠:** 몸, 머리 (뼈 토글), 얼굴 (스프라이트 토글).
    - **색상:** 틴트 적용 (그레이스케일/흰색 소스 에셋 필요).
    - **저장:** JSON 구조를 `users/{uid}/characters`에 저장.

### C. 게임 엔진 코어 (`src/engine.js`, `src/camera.js`)
- **뷰포트:** 모바일 전체 화면(아이폰/아이패드 세로모드 고정).
- **Z-정렬:** **중요.** 깊이를 확인하기 위해 매 프레임마다 Y 좌표로 `WorldContainer` 자식 재정렬.
- **골격 렌더러:** 코드 측에서 Container 뼈를 회전하여 절차적 애니메이션 (걷기).
- **카메라/줌:** 
    - 토글 버튼 `[ 🔍 ]`: **48px (1.0x)**와 **64px (1.33x)** 사이 전환.
    - **중앙 정렬:** 로컬 플레이어는 항상 화면 중앙에 있어야 함.

### D. 입력 및 이동 (`src/pathfinder.js`, `src/input.js`)
- **제어:** 탭하여 이동 (포인트 앤 클릭).
- **피드백:** 터치 지점에 시각적 '타겟 마커' 애니메이션 (0.5초).
- **로직:** 
    1. 그리드 변환 -> 충돌 체크 (`1` = 차단).
    2. **A* 경로 찾기:** 최단 경로 계산.
    3. **스무딩:** 타일 간 Lerp 이동. 방향에 따라 스프라이트 미러링.

### E. 네트워크 및 채팅 (`src/network.js`, `src/ui.js`)
- **동기화:** 
    - 로컬: 100ms 쓰로틀.
    - 원격: 부드러운 랙 보상을 위한 선형 보간(Lerp).
- **오프라인:** `onDisconnect`를 처리하여 플레이어 존재 제거.
- **채팅:** 
    - 입력: 기본적으로 숨김. `[ 💬 ]` 토글로 키보드 + 입력 바 슬라이드 업. 
    - **간격 없음:** 입력 바가 흰 공간 없이 키보드 위에 위치하도록 뷰포트 조정 보장.
    - **표시:** 머리 위 말풍선 (둥근 사각형), 5초 후 자동 소멸.

### F. 주택 및 인테리어 (`src/housing.js`, `src/interior.js`, `src/portal.js`)
- **고스트 건물:** 커서를 따라가는 3x3 반투명 시각. 배치가 유효하지 않으면 빨간색 틴트.
- **배치:** 특정 3x3 그리드 영역을 `Collision(1)`로 업데이트.
- **포털:** 
    - **입장:** '문' 타일 탭 -> 페이드 아웃 -> `currentMap` 전환 -> 인테리어로 텔레포트.
    - **퇴장:** '매트' 타일 탭 -> 페이드 아웃 -> `world` 전환 -> 문 앞으로 텔레포트.
- **필터링:** 동일한 `currentMap` ID를 공유하는 엔티티만 렌더링.
- **인테리어:** 10x10 고정 방. 가구 배치 허용 (문 앞 제외).

### G. 경제 및 거래 (`src/shop.js`, `src/trade.js`)
- **상점:** 고정 맵 위치 (타운 센터). 모달 팝업.
    - **동적 가격:** 시드(`DateString`) 기반 일일 변동. 범위: 0.8 ~ 1.3배.
- **P2P 거래:**
    - **상호작용:** 사용자 탭 -> 인접 타일로 이동 -> `[ 🤝 거래 ]` 말풍선 표시.
    - **흐름:** 요청 -> 창 열기 -> 제안 -> 잠금 -> 확인 -> 거래.

### H. RPG 및 전투 (`src/rpg_core.js`, `src/monster.js`)
- **스탯:** 레벨, XP, HP/MaxHP, Str/Vit/Int/Agi.
- **진행:** 레벨 업 -> +3 자유 포인트.
- **몬스터:** 
    - **AI:** 대기 (랜덤 워크) -> 감지 (3타일) -> 추격 -> 공격 (1타일).
    - **전투:** 단순 HP 감소.
- **사망:** `HP <= 0` -> 기절 상태 -> 화면 페이드 -> 3초 후 "우물" (타운 센터)에서 리스폰.

### I. 환경 및 자원 (`src/environment.js`)
- **채집:** 자원 탭 (나무/바위) -> 흔들림 애니메이션 -> 아이템 드롭.
- **드롭:** 포물선 트윈 애니메이션 (위 -> 아래). 그림자 투사.
- **루팅:** 드롭 탭 -> 가방으로 날아가는 애니메이션 (베지어) -> 인벤토리 `+1`.
- **재생:** 
    - 고갈된 객체는 `active: false` 설정 (보이지 않음/충돌 없음).
    - 타이머 체크 (예: 나무 5분) -> `active: true`로 복원.

### J. 임대 시스템 (`src/housing_rental.js`)
- **여관:** 집이 없는 플레이어를 위한 임대 방.
- **로직:** 골드 지불 -> 여관 방으로 스폰 포인트 설정.

## 5. 에셋 규칙
- **경로:** `assets/`
- **이름 지정:** 
    - 파츠: `body_basic.png`, `head_{n}.png`, `arm_basic.png`
    - 타일: `tile_grass.png`, `tile_wall.png`
    - 객체: `building_house_01.png` (3x3), `furniture_bed.png`
- **틴트 규칙:** 모든 틴트 가능 스프라이트 (피부, 머리)는 **반드시 그레이스케일 또는 흰색**이어야 함.

## 6. 테스트 자격 증명
- **테스트 PIN:** `0000`
