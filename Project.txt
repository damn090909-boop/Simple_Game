# Family Town Development Guidelines

## 1. Project Overview
**Target Platform:** iOS/iPadOS Chrome Browser (PWA Standalone)
**Core Concept:** 4-Player Family Multiplayer Game (RPG + Sim)
**Tech Stack:** 
- **Frontend:** PixiJS v7+ (Render), Firebase v9 Modular (Auth/DB)
- **Style:** 48px Grid Tile, Skeletal (Cutout) Animation, Pixel Art (Nearest Scale)

## 2. Technical Constraints & iOS Optimization
1.  **Rendering:** `PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST` (Mandatory).
2.  **PWA/Touch:** 
    - Strict control of `overscroll-behavior`, `touch-action: none`.
    - `user-select: none` to prevent text selection/magnifiers.
    - Meta tags for `apple-mobile-web-app-capable`.
3.  **Audio:** `AudioContext` must be resumed on the very first user interaction (PIN Keypad touch).
4.  **Device Aspect:** 16:9 Landscape Ratio (simulated on desktop, native on mobile).

## 3. Database Schema (Firebase Realtime DB)
| Path | Structure & Description |
| :--- | :--- |
| `users/{userID}` | `{ pin: "1234", avatar: {...} }` |
| `users/{userID}/characters` | List of created characters (Max 3). |
| `users/{userID}/currentMap` | Current location ID (default: `"world"`). |
| `players/{userID}` | Ephemeral game state (x, y, anim, direction). |
| `players/{userID}/stats` | RPG Stats: `{ level, xp, hp, max_hp, str... }`. |
| `players/{userID}/inventory` | Personal items. |
| `players/{userID}/wallet` | Currency: `{ gold: 1000 }`. |
| `world/buildings/{buildID}` | Exterior buildings: `{ type, x, y, owner, interiorID }`. |
| `world/drops` | Shared field items (FIFO pickup). |
| `interiors/{interiorID}/items` | Furniture placement inside houses. |
| `trades/{sessionID}` | P2P Trade session data. |

## 4. Module Specifications

### A. Authentication System (`src/auth.js`)
- **UI:** Only a numeric keypad (0-9) and input field. No extra buttons.
- **Logic:** Auto-login upon 4-digit entry. 
- **Security:** Use `.indexOn: ["pin"]` in DB rules for efficiency.
- **Trigger:** First tap on keypad resumes AudioContext.

### B. Lobby & Customization (`src/lobby.js`)
- **Slots:** 3 Character Cards.
    - *Exists:* Preview (Skeletal), Info, Enter/Delete buttons.
    - *Empty:* Black Silhouette + [+] Button.
- **Character Creator:** 
    - **Parts:** Body, Hair (Bone toggle), Face (Sprite toggle).
    - **Color:** Tint application (Requires Grayscale/White source assets).
    - **Save:** Stores JSON structure to `users/{uid}/characters`.

### C. Game Engine Core (`src/engine.js`, `src/camera.js`)
- **Viewport:** Mobile Fullscreen.
- **Z-Sorting:** **Critical.** Re-sort `WorldContainer` children by Y-coordinate every frame to verify depth.
- **Skeletal Renderer:** Procedural animation (walking) by rotating Container bones code-side.
- **Camera/Zoom:** 
    - Toggle Button `[ ðŸ” ]`: Switch between **48px (1.0x)** and **64px (1.33x)**.
    - **Centering:** Local player must ALWAYS be center-screen.

### D. Input & Movement (`src/pathfinder.js`, `src/input.js`)
- **Control:** Tap-to-move (Point & Click).
- **Feedback:** Visual 'Target Marker' animation at touch point (0.5s).
- **Logic:** 
    1. Grid conversion -> Collision Check (`1` = Block).
    2. **A* Pathfinding:** Calculate shortest path.
    3. **Smoothing:** Lerp movement between tiles. Mirror sprite based on direction.

### E. Network & Chat (`src/network.js`, `src/ui.js`)
- **Sync:** 
    - Local: 100ms Throttle.
    - Remote: Linear Interpolation (Lerp) for smooth lag compensation.
- **Off-line:** Handle `onDisconnect` to remove player presence.
- **Chat:** 
    - Input: Hidden by default. Toggle `[ ðŸ’¬ ]` slides up keyboard + input bar. 
    - **No-Gap:** Ensure Viewport adjustment so input bar sits on top of keyboard without white space.
    - **Display:** Bubble above head (Rounded Rect), auto-destroy after 5s.

### F. Housing & Interiors (`src/housing.js`, `src/interior.js`, `src/portal.js`)
- **Ghost Building:** 3x3 semitransparent visual following cursor. Red tint if invalid placement.
- **Placement:** Updates specific 3x3 grid area to `Collision(1)`.
- **Portal:** 
    - **Enter:** Tap 'Door' tile -> Fade Out -> Switch `currentMap` -> Teleport to interior.
    - **Exit:** Tap 'Mat' tile -> Fade Out -> Switch `world` -> Teleport to door front.
- **Filtering:** Only render entities sharing the same `currentMap` ID.
- **Interior:** 10x10 fixed room. Furniture placement allowed (except door frontage).

### G. Economy & Trade (`src/shop.js`, `src/trade.js`)
- **Shop:** Fixed map location (Town Center). Modal Popup.
    - **Dynamic Price:** Daily fluctuation based on Seed (`DateString`). Range: 0.8 ~ 1.3x.
- **P2P Trade:**
    - **Interaction:** Tap User -> Move to adjacent tile -> Show `[ ðŸ¤ Trade ]` Bubble.
    - **Flow:** Request -> Window Open -> Offer -> Lock -> Confirm -> Transaction.

### H. RPG & Combat (`src/rpg_core.js`, `src/monster.js`)
- **Stats:** Level, XP, HP/MaxHP, Str/Vit/Int/Agi.
- **Progression:** Level Up -> +3 Free Points.
- **Monsters:** 
    - **AI:** Idle (Random Walk) -> Detect (3 tiles) -> Chase -> Attack (1 tile).
    - **Combat:** Simple HP deduction.
- **Death:** `HP <= 0` -> Faint State -> Screen Fade -> Respawn at "Well" (Town Center) after 3s.

### I. Environment & Resources (`src/environment.js`)
- **Gathering:** Tap Resource (Tree/Rock) -> Shake Anim -> Drop Item.
- **Drops:** Parabola Tween animation (Up -> Down). Shadow casting.
- **Looting:** Tap Drop -> Fly-to-bag animation (Bezier) -> Inventory `+1`.
- **Regeneration:** 
    - Depleted objects set `active: false` (Invisible/No-collision).
    - Timer check (e.g., Tree 5min) -> Restore to `active: true`.

### J. Rental System (`src/housing_rental.js`)
- **Inn:** Rental room for players without houses.
- **Logic:** Pay gold -> Set spawn point to Inn Room.

## 5. Asset Conventions
- **Path:** `assets/`
- **Naming:** 
    - Parts: `body_basic.png`, `head_{n}.png`, `arm_basic.png`
    - Tiles: `tile_grass.png`, `tile_wall.png`
    - Objects: `building_house_01.png` (3x3), `furniture_bed.png`
- **Tint Rule:** All tintable sprites (Skin, Hair) **MUST be Grayscale or White**.
